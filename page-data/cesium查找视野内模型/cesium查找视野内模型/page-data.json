{"componentChunkName":"component---src-templates-blog-post-index-jsx","path":"/cesium查找视野内模型/cesium查找视野内模型/","result":{"data":{"site":{"siteMetadata":{"title":"QDS"}},"markdownRemark":{"id":"fb9c2cf5-55e2-5e84-a59d-b32030320d28","excerpt":"背景 最近遇到一个需求，要求在camera移动的过程中把视野范围内的所有3dtiles单体化后的模型找到。但这很显然是不合理的，因为没有控制视野的长度，理论上camera…","html":"<h2>背景</h2>\n<p>最近遇到一个需求，要求在camera移动的过程中把视野范围内的所有3dtiles单体化后的模型找到。但这很显然是不合理的，因为没有控制视野的长度，理论上camera的视野长度是无限长的，所以最后需求更改为探测合理范围内的模型。</p>\n<h2>思路</h2>\n<p>完成这个功能理论上需要将摄像机的视野范围和单体化模型进行碰撞计算，将单体化模型包含或相交于视野的模型找出来即可。首先需要实体化摄像机视野,这里可以采用单独建立一个Cesium.PerspectiveFrustum类来实例化。</p>\n<p><a href=\"https://cesium.com/learn/cesiumjs/ref-doc/PerspectiveFrustum.html?classFilter=PerspectiveFrustum\">https://cesium.com/learn/cesiumjs/ref-doc/PerspectiveFrustum.html?classFilter=PerspectiveFrustum</a></p>\n<p>在实例化的过程中，可以把视野看作是顶点在camera位置的四棱锥，可以定义fov、aspectRatio、aspectRatio、far来定义四棱锥的形状，然后使用改实体化对象使用computeCullingVolume方法建立一个<a href=\"https://cesium.com/learn/cesiumjs/ref-doc/CullingVolume.html\">CullingVolume</a>，这里的position、direction、up可以使用此时camera的属性。</p>\n\n        <deckgo-highlight-code language=\"jsx\"  terminal=\"carbon\" theme=\"lucario\" >\n          <code slot=\"code\">const cullingVolume = new Cesium.PerspectiveFrustum({\n\t\tfov: Cesium.Math.toRadians(100.0),\n\t\taspectRatio: viewer.scene.drawingBufferWidth / viewer.scene.drawingBufferHeight,\n\t\tfar: 6,\n\t\tnear: 0.1\n\t}).computeCullingVolume(\n\t\tviewer.camera.positionWC,\n\t\tviewer.camera.directionWC,\n\t\tviewer.camera.upWC\n\t);</code>\n        </deckgo-highlight-code>\n      \n<p>另外，在设置四棱锥由于看不见本身的样子，就会导致效率效率异常慢，很容易影响心态，所以这里可以使用<em>Cesium.DebugCameraPrimitive来进行测试。</em></p>\n<p><a href=\"https://cesium.com/learn/cesiumjs/ref-doc/DebugCameraPrimitive.html?classFilter=debug\">https://cesium.com/learn/cesiumjs/ref-doc/DebugCameraPrimitive.html?classFilter=debug</a></p>\n<p>使用之前最好重新先建立一个camera,并设置好<em>position、directionWC、upWC等属性，然后就可以开始调试fov、near、far等参数。</em></p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9c9be5872f5814ea76c65b02c5624fd4/9cea8/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFNklEQVQ4y22Ua2yTVRjH37bvrRfmLspEQEhcIDEj+oGBg+AFhrDeNsYQJTgVr9EEGyXIB0XgG4vhw4wCgg10HWQhBkq7ru0oY4WhaACDGJWt7dsLMnWX+Al83+T9+5y3nXj78M/Tc07P7/0/5zzn4Xbt2rWyrq7umCiKh+12u1+W5f/IZrP6HQ6rf8YMmxFNFouf48xlWfx1C6oO1dZW9JrN4nouEAhsb2xsBMdx4HkeVqu1LBk2W0mCING6QOJJFlTfa8XihvvwymsLcOCzBsQTT2D+vEq21sUFe4Jbu4Pd6Oh4/s68efM1ApdlIfGGqqrtWsOSmdrrbyzQ/EeWal9eatLGxjza5GSL9ofapiUSj98WJRGSLO7lAt1HffGBGAbPJbVQ6JS+e/dOfenSRr1+0QP6lpcf0g8ebNDPn1+lFwtunQD65IRXH7vl1nNZpz460qxP0NwHO+tVjjNhxj1SJxcIHvWFIxGcDPVrfdGkfnbwIuLxOL65vANTv7dhYqIVY2Nu5BQnMmmXoWzGaYyVrJPWPHC65hhAm0Ps5I4Egr5Y4gukhj/XBlOH9dTwPvzw46vI5duRybQjnW4jQCsBPCgWniY10e9mmnOjmHfj+vW1mD3bodJFQbIKnVzXx0Ff6sJ+5AseTcmv0/OFFvq9DkqunbQeitKOQq4NBZq79p0PV6++g0y2haCrMDHuRG/vcgiiqIqyAFHmO+n8a3zvbnsS45MbtXSmXc8qGwi0wQBmCZbLt2EkvQXDF/cjEo3jdCSO5OAJfHVpD26NvYC3fXWsQlTZJpBDkQE5n7d1FiamWrWM4tUVclNyVwYWWpG6cBih8CABQ6TTiMbiNB5AfOA0Ptq3B8tWLFetdpmBS0CXdw5+Hfdq2bxLVwouKHkvwejslPXIZjdiIBkgUB/641FSvxGj/WFyG0bizABS54fU/Qc+RceLHSXgU6tnkX2Pls2VgLkiQQt0s3ToI6ObEe47SZtj5CyMWGIa2Efjkugj6tlzSZwKnSwBl624H4W8W8sqTp1cEtBtSCk4kc15cOXqNsTi3QhHEuQ0RumG6CMMHjPU19+nRqIRdPcESsDFS2Yin3cZDjN5ljJzSPVGMZtzIl9sQlppodp8D8mzxzE4lDScMmh/LMqkRin2HAsyoMlX/0gNlYeLyoaABPiHCJrJUeqZtRifWoNvr3nw5lubcehzP13WENgrC4VPqSz13hO9DGj21S2soiJ2arl/AZnDNL2IUXoR41MtSCRXYdGjNUYjqa6pwXObNiHY001llFQTZxLoOd7DgBbf3PmVGB1t1nKFEnA6XQZi8bfJFnR9shiOSpvRdWSHDLNgLoOr8cyzG1SCsfMtOZw5y4GfbjRr+eJdIIPdpDecpZtmbYr+B5PAQ7JL4GURolWCbLPBIvBGYc9+cA7crd7SGVZSf7v+/VqtcNOtsxRHMs3kyouLl5rw2PJasIdPrwCijSeYhSRBkGSITLJMYLtq5i3lwjZZfBVVVly+stpwyIDsvI4GG1FLzllaVjvByJUg82WJJUksMrikStSUJatMQLPoc1RYMXRhpfbLuFcv/uzB9h314Hjq0BYTZLtAG3hy8zcZUAG8JBhgcqoypwTu5Ew8v5Wdy9eXm+7cSDu1Nc1zqUubNdqgiXZB4ykKZVFXpiiWIomARiTQ7TJwL3V483ZbhYj3P1yEhQ9XGSnK0ylK4t30KDW2aVpszDOXctllCdhFGVu8lFbKZOGjdKAxq0OIU4r/IzYvkcS/Ijk0RGtRGg+TXvoTCcK8oQxIRTsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/9c9be5872f5814ea76c65b02c5624fd4/fcda8/1.png\"\n        srcset=\"/static/9c9be5872f5814ea76c65b02c5624fd4/12f09/1.png 148w,\n/static/9c9be5872f5814ea76c65b02c5624fd4/e4a3f/1.png 295w,\n/static/9c9be5872f5814ea76c65b02c5624fd4/fcda8/1.png 590w,\n/static/9c9be5872f5814ea76c65b02c5624fd4/efc66/1.png 885w,\n/static/9c9be5872f5814ea76c65b02c5624fd4/c83ae/1.png 1180w,\n/static/9c9be5872f5814ea76c65b02c5624fd4/9cea8/1.png 1278w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></td>\n<td><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0018e8488c265f653e9eb088c6f65def/d7ceb/2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 111.48648648648648%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAE60lEQVQ4y12VW2wUVRjHT3cu58yZXUBIBQKhEl64qfHBQFqIJqKk3bZbeoOA8QFj8IIPEkmEB1jjA9FAjAQ2xJhAUS6FJkq723axpYgtFpWIwUSF7rXbCxRaxUTITLJ/vzO7KeDDP2fmzJnffPdhQlpbLFv+QOokxS3bjku/jAdm2nHLb8dNaZFEQULEDVFYHxXtddE6QOs7jID7CARPUkIWV8ZMcMuC5Re0cnDJvZVe+p94UXTN+VFmWtYeIRXEuk9yORduYIZ0N29e4gYClstKdNf2C1cIw+UkU4k/IrVvmQ9E4YOHFTDsAS3Lsf0WWaZh+7vL8O/9epw5W4HFS2Z5e9LmENIEAehF07NYQdQ905jLGKNzLMIEAZWLgYB0GNNRsWY+stlqpNNVmLhbi1+vr0dlcCEdLpmGMZ8PRQB8ug/zFsx1K9aWY0N9HQGFCEvbgmEK58nSGRgYeAnjt2qQTAcxlKzC8Gg1RsZqsGv3Smi6QQATi8oWomLtGmx7+00c+PQATrWecnv7etEebSegJKDnqnCOfL4ak1N1SKSqkM5UIUXyrsniqb9DiHWuw8FDYbSePYeevm9x8fs+XLjUh1h3p9sR68Dp1tYIIzfCyvQ3tpU5U39VIpN5BZlskNYQQTcgmW0gYCNyuTrc+6cOE3dew8DgEXwTPY+v28+ho7MDnee73Iv936E91hFhtn92uHzts7j6y05ncPAQfryyH9nMJgI2e0pmmpAgZRR0NISx8SDGblXh6rW96L14Hj0XetHy1XF3z0d70by5OcI+O3gw3NXVie7uXica7UcsdgG/XX+PElOHTHojJafJg6aHGwgUwui4gtZgdKwKO3a+iudXl6N0bunDLJ84eSIcjUURjXU7l/pb8Psf25HKkkXpRlKTJwXN5jYgR8lJDysLa9B/eR00s5BpzdCoFgVMS0TYseMt4faOKH6++qGTSTd4lilAOkWxS9dTYkL0gRqkCKRgQ6qcJmvxxbFV8BkGhF91lFfgqlMi7HTr2XBPTzdu/LnRSSZDSKYUpJYA1UgOVz0mBb2ZqsQUJWfnruWedcJPIKEXgUaEbd26Pbz/wFsYn6hzcuPVuJmspMyqlwmSCz6iAjRBz8Zu1yLUsGgaqFu6S1AC6hHaY2GfxtDY/JQz+NPLmJwkF9Oq/iqpXApupopSH8qMkNtUm0tXzgYrMWBS++mCu96A4KYqbCuspgr1q1M6L4CPP3kOwyM1XrckEpVegWcIlslRCOh6hLy4fGUd/DMlxVCSuxI6l67BZQFIgQzTLIOwLYdp1KfUz2tenI+u+AvUNSFklWVetwSRIMtvU0KOtqxCiUYxo75W0oVJFpqPA8lkh9JOU0R4g0D4OXa8vxw3hghypxYJ6usbQ5SQe3X4YPeKhwmxdC+GOsVQV0lRwOKwdHQu8oYw8tw28hrX8/RSftnTc/JfnizPEzSfyQXzVIv5+qYy7xkBvfMEKwIpKTrne1RAKbD3VXB1GpjqAH3ZpRqjDtBcpmnupi2L3WvX17sTd0PuimeeoMFb4prSIFe98w+MAvAwMyy+j/4X0/EwvDFvetLV/LOVW4bn4oKyANXfCsyaI1BiaN7+tLw61I9SlmWjoB+TsMUZbvM2bss2LmUbTfKCpNoz2+RM3sY0XxvFt43ajM6Y9GxaZ+i+iwvz9f8AP9Ys/WwzTQwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/0018e8488c265f653e9eb088c6f65def/fcda8/2.png\"\n        srcset=\"/static/0018e8488c265f653e9eb088c6f65def/12f09/2.png 148w,\n/static/0018e8488c265f653e9eb088c6f65def/e4a3f/2.png 295w,\n/static/0018e8488c265f653e9eb088c6f65def/fcda8/2.png 590w,\n/static/0018e8488c265f653e9eb088c6f65def/efc66/2.png 885w,\n/static/0018e8488c265f653e9eb088c6f65def/c83ae/2.png 1180w,\n/static/0018e8488c265f653e9eb088c6f65def/d7ceb/2.png 1446w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></td>\n</tr>\n</tbody>\n</table>\n<p>回到上面建立好了<a href=\"https://cesium.com/learn/cesiumjs/ref-doc/CullingVolume.html\">CullingVolume</a>之后，就可以使用它的computeVisibility方法和3dtiles单体化模型的BoundingSphere进行计算，最后的结果如果是Cesium.Intersect.OUTSIDE说明不在视野范围内。这里的BoundingSphere可以使用3dtiles的scenetree.json中获取。</p>\n<h2>部分代码</h2>\n\n        <deckgo-highlight-code language=\"jsx\"  terminal=\"carbon\" theme=\"lucario\" >\n          <code slot=\"code\">const cullingVolume = new Cesium.PerspectiveFrustum({\n\tfov: Cesium.Math.toRadians(100.0),\n\taspectRatio: viewer.scene.drawingBufferWidth / viewer.scene.drawingBufferHeight,\n\tfar: 6,\n\tnear: 0.1\n}).computeCullingVolume(\n\tviewer.camera.positionWC,\n\tviewer.camera.directionWC,\n\tviewer.camera.upWC\n);\n\n//创建测试camera\nconst camera = new Cesium.Camera(viewer.scene);\ncamera.position = new Cesium.Cartesian3( ..., ..., ... );\ncamera.direction = new Cesium.Cartesian3( ..., ..., ... );\ncamera.up = new Cesium.Cartesian3( ..., ..., ... );\ncamera.frustum.fov = Cesium.Math.toRadians(80.0);\ncamera.frustum.near = 0.1;\ncamera.frustum.far = 9;\n\nviewer.scene.primitives.add(new Cesium.DebugCameraPrimitive({\n\tcamera: camera,\n\tcolor: Cesium.Color.YELLOW\n}));\n\n// 判断是否碰撞\nconst visibility = cullingVolume.computeVisibility(boundingSphere);\nif(visibility === Cesium.Intersect.OUTSIDE) return;</code>\n        </deckgo-highlight-code>\n      ","frontmatter":{"title":"cesium查找视野内模型","date":"November 20, 2021","description":"Hello World"}}},"pageContext":{"slug":"/cesium查找视野内模型/cesium查找视野内模型/","previous":{"id":"dac6849e-8871-5e7c-b5cd-56f90e267c44","frontmatter":{"title":"乱记 2021-11-19 mapbox(一)","tags":["day","gis","mapbox"],"date":"2021年11月19日"},"fields":{"slug":"/day-2021-11-9-mapbox(一)/"},"excerpt":"MapBox.js在2013年发布1.0版本并且成为leaflet的插件，提供了很方便调用mapbox底图的方法。点击查看 MapBox.js is now a Leaflet plugin, which means that our hosted library…"},"next":null}}}